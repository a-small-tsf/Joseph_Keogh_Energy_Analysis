---
title: "Database Connection and Population"
author: "Joseph Keogh"
date: "10/12/2020"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RPostgreSQL)
library(tidyverse)
library(lubridate)
library(httr)
```

## Retrieve data from PJM

### Load in all the p_nodes - these are energy sections designated by an integer key
```{r}
pnodes <- read_csv(
  "PJM_pnode-by-state.csv",
  col_types = cols(
    PNODEID = col_character()
  )
  )

pnodes <- filter(pnodes, STATE=='VA')

pnodes <- head(pnodes, 1)
```


### Connect and get raw energy data
```{r}

# time this operation
start_time <- proc.time()

# the dataframe that will contain all of our data
response <- data.frame()

count <- 0

for (pnode in pnodes$PNODEID){
  
  count <- count + 1
  
  # query the pjm system
  r <- GET(
    "https://api.pjm.com/api/v1/rt_unverified_fivemin_lmps", 
    add_headers("Ocp-Apim-Subscription-Key" = "625845c6fabc4639ab91428486d8d2e2"),
    query = 
      list(rowCount = 1000, startRow = "1", 
           pnode_id = pnode, 
           sort='datetime_beginning_ept'
           )
    )
  
  temp = httr::content(r,"parsed")
  
  if (nrow(response) == 0){
    response = data.table::rbindlist(temp[['items']])
  }
  
  else{
    response <- rbind(response, data.table::rbindlist(temp[['items']]))
  }
  
  print(count)
  print(nrow(response))
  
}

# time this operation
end_time <- proc.time()
print(end_time - start_time)

nrow(response)
head(response, 10)

```

It takes four seconds to get 1000 data points from one pnode

### Create Dataframe for Energy Data
```{r}

energy_clean <- gen_data_today %>%
  
  # remove empty data
  na.omit() %>%
  
  # create date object
  mutate(date = str_sub(datetime_beginning_utc, 1, 10)) %>%
  mutate(date = ymd(date)) %>%
  
  # create time object
  mutate(time = str_sub(datetime_beginning_utc, 12, 19)) %>%
  mutate(time = hms(time)) %>%
  
  # create datetime object
  mutate(datetime = ymd(date)+hms(time)) %>%
  
  # only bring values we need
  select(datetime, date, time, pnode_id, pnode_name, total_lmp_rt)

```

### Connect and get raw forecasting data
```{r}

```

### Create dataframe for forecasting data
```{r}

```


## Insert data into database

### DB Connection
```{r}
# load credentials
username <- "jgk7uf@va-energy2"
hostname <- "va-energy2.postgres.database.azure.com"
password <- "0Tn5KBFbm2&6bG"
dbname <- "postgres"

# open credentials
db_driver <- dbDriver("PostgreSQL")
db <- dbConnect(db_driver, user=username, password=password, dbname=dbname, host=hostname)

# test connection if returns true the db is connected
print(dbExistsTable(db, "test_table"))
```

### Create tables
```{r}

# drop existing data
dbGetQuery(db, "DROP TABLE test_table")

# create and write table
dbWriteTable(db, "test_table", energy_clean, row.names=FALSE)

```

## End of file
```{r}
"End of File"
```




























